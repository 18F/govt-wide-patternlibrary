{# TODO: Clean this up. #}
{% import _self as menus %}

{{ menus.menu_links(items, 0, megamenu) }}

{% macro menu_links(items, menu_level, megamenu, button_id) %}
  {% import _self as menus %}

  {% if items %}

    {# 1st level #}
    {% if menu_level == 0 %}
      {# TODO: Create a button icon component #}
      <button class="usa-nav__close">
        <img src="{{ img_path|default('../../img/usa-icons') }}/close.svg" role="img" alt="close">
      </button>
      <ul class="usa-nav__primary usa-accordion">
    {# 2nd level subnavs that aren't megamenu #}
    {% elseif menu_level > 0 and not megamenu %}
      <ul id="{{ button_id }}" class="usa-nav__submenu">
    {# Megamenu default list #}
    {% else %}
      <ul class="usa-nav__submenu-list">
    {% endif %}

    {% for item in items %}
      {% if menu_level > 0 %}
        {% set list_classes = 'usa-nav__submenu-item' %}
      {% else %}
        {% set list_classes = 'usa-nav__primary-item' %}
      {% endif %}

      <li class="{{ list_classes }}">
        {% if menu_level == 0 and item.subnav %}
          {# TODO: Use or create a toggle button component #}
          {% set btn_classes = 'usa-accordion__button usa-nav__link' ~ ((item.current) ? ' usa-current') %}
          <button class="{{ btn_classes }}" aria-expanded="false" aria-controls="{{ item.id }}">
            <span>{{ item.label }}</span>
          </button>
          {% if megamenu %}
            <div id="{{ item.id }}" class="usa-nav__submenu usa-megamenu">
              <div class="grid-row grid-gap-4">
                {% for column in item.subnav|batch(3) %}
                  <div class="usa-col">
                    {{ menus.menu_links(column, menu_level + 1, megamenu, item.id) }}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% else %}
            {{ menus.menu_links(item.subnav, menu_level + 1, megamenu, item.id) }}
          {% endif %}
        {% else %}
          <a href="{{ item.href }}" {% if menu_level == 0 %} class="usa-nav-link" {% endif %}>
            {% if megamenu %}
              {{ item.label }}
            {% else %}
              <span>{{ item.label }}</span>
            {% endif %}
          </a>
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  {% endif %}
{% endmacro %}
