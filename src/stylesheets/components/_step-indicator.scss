$step-indicator-label-margin-top: 1;
$step-indicator-margin-bottom: 4;
$step-indicator-segment-height-mobile: 1;

.usa-step-indicator {
  @include typeset(
    $theme-step-indicator-font-family,
    $theme-step-indicator-label-font-size,
    2
  );
  @include u-margin-x($theme-step-indicator-gap / -2);
  background-color: color($step-indicator-background-color);
  margin-bottom: units($step-indicator-margin-bottom);

  @include at-media($theme-step-indicator-min-width) {
    @include u-margin-x(0);
  }
}

.usa-step-indicator__segments {
  counter-reset: usa-step-indicator;
  display: flex;
  list-style: none;
  margin: 0;
  padding: 0;
}

.usa-step-indicator__segment {
  @include u-flex("fill");
  @include u-margin-x($theme-step-indicator-gap / 2);
  counter-increment: usa-step-indicator;
  max-width: units("card") + units(5);
  min-height: units($theme-step-indicator-segment-height);
  position: relative;

  @include at-media($theme-step-indicator-min-width) {
    $counter-lh: lh($theme-step-indicator-font-family, 1);
    // Remove segment gaps
    @include u-margin-x(0);
    // Add extra margin for counter
    @if $theme-step-indicator-counter-gap != 0 {
      margin-top: calc(
        ((#{units($theme-step-indicator-counter-size)} - #{units($theme-step-indicator-segment-height)}) / 2) + #{units($theme-step-indicator-counter-gap)}
      );
    }
    @else {
      margin-top: calc(
        ((#{units($theme-step-indicator-counter-size)} - #{units($theme-step-indicator-segment-height)}) / 2)
      );
    }
    // Add counter
    &:before {
      @include u-circle($theme-step-indicator-counter-size);
      @include u-text("tabular");
      background-color: color($step-indicator-background-color);
      box-shadow:
        inset 0 0 0 units($theme-step-indicator-counter-border) color($theme-step-indicator-segment-color),
        0 0 0 units($theme-step-indicator-counter-gap) color($step-indicator-background-color);
      color: color($theme-step-indicator-segment-color-complete);
      content: counter(usa-step-indicator);
      display: block;
      font-weight: fw("bold");
      line-height: lh($theme-step-indicator-font-family, 1);
      // Magic number circle centering
      padding: calc(
        (#{units($theme-step-indicator-counter-size)} - (2ex * #{$counter-lh})) * .5
      );
      // padding: 1.5ex;
      position: absolute;
      top: calc(
        (#{units($theme-step-indicator-counter-size)} - #{units($theme-step-indicator-segment-height)}) / -2
      );
      left: 0;
      text-align: center;
      z-index: z(100);
    }
  }

  // Add segment
  &:after {
    background-color: color($theme-step-indicator-segment-color);
    content: "";
    display: block;
    // Use a fixed segment height for mobile regardless of settings
    height: units($step-indicator-segment-height-mobile);
    left: 0;
    position: absolute;
    right: 0;
    top: 0;

    @include at-media($theme-step-indicator-min-width) {
      height: units($theme-step-indicator-segment-height);
    }
  }

  @include at-media($theme-step-indicator-min-width) {
    &:last-child {
    // Don't show the last segment when counters appear
    &:after {
        display: none;
      }
    }
  }
}

.usa-step-indicator__segment--complete {
  &::before {
    background-color: color($theme-step-indicator-segment-color-complete);
    box-shadow: 0 0 0 units($theme-step-indicator-counter-gap) color($step-indicator-background-color);
    color: color($step-indicator-background-color);
  }
  &::after {
    background-color: color($theme-step-indicator-segment-color-complete);
  }
  .usa-step-indicator__segment-label {
    color: color($theme-step-indicator-segment-color-complete);
    font-weight: fw("bold");
  }
}

.usa-step-indicator__segment--current {
  &::before {
    background-color: color($theme-step-indicator-segment-color-current);
    box-shadow: 0 0 0 units($theme-step-indicator-counter-gap) color($step-indicator-background-color);
    color: color($step-indicator-background-color);
  }
  &::after {
    background-color: color($theme-step-indicator-segment-color-current);
  }
  .usa-step-indicator__segment-label {
    color: color($theme-step-indicator-segment-color-current);
    font-weight: fw("bold");
  }
}

.usa-step-indicator__segment-label {
  display: none;
  // Show labels only at the min-width
  @include at-media($theme-step-indicator-min-width) {
    color: color($theme-step-indicator-segment-color-complete);
    display: block;
    font-size: size(
      $theme-step-indicator-font-family,
      $theme-step-indicator-label-font-size
    );
    margin-top: calc(
      ((#{units($theme-step-indicator-counter-size)} + #{units($theme-step-indicator-segment-height)}) / 2) + #{units($step-indicator-label-margin-top)}
    );
    padding-right: units(4);
    text-align: left;
  }
}

.usa-step-indicator__header {
  align-items: baseline;
  display: flex;
}

.usa-step-indicator__heading {
  font-family: family($theme-step-indicator-heading-font-family);
  font-size: size(
    $theme-step-indicator-heading-font-family,
    $theme-step-indicator-heading-font-size-small
  );
  font-weight: font-weight("bold");
  margin: units(4) 0 0;
  @include at-media($theme-step-indicator-min-width) {
    font-size: size(
      $theme-step-indicator-heading-font-family,
      $theme-step-indicator-heading-font-size
    );
  }
}

$step-font-size: size(
  $theme-step-indicator-heading-font-family,
  $theme-step-indicator-heading-font-size
);

.usa-step-indicator__current-step {
  $step-lh: lh($theme-step-indicator-heading-font-family, 2);
  @include u-circle($theme-step-indicator-counter-size);
  @include u-text("normal", "tabular");
  background-color: color($theme-step-indicator-segment-color-current);
  color: color("white");
  display: inline-block;
  // Magic number circle centering
  padding: calc(
    (#{units($theme-step-indicator-counter-size)} - (2ex * #{$step-lh})) * .5
  );
  text-align: center;
}

.usa-step-indicator__total-steps {
  @include u-text("normal", "tabular");
  margin-right: units(1);
}

.usa-step-indicator--no-counter,
.usa-step-indicator--no-labels {
  @include u-margin-x($theme-step-indicator-gap / -2);

  .usa-step-indicator__segment {
    // Add gap between segments
    @include u-margin-x($theme-step-indicator-gap / 2);
    // Remove extra counter margin
    margin-top: 0;
    &:before {
      // Don't show counters
      display: none;
    }
    &:last-child {
      // Show last segment
      &:after {
        display: block;
      }
    }
  }
  // Remove extra margin for counters
  .usa-step-indicator__segment-label {
    margin-top: calc(
      #{units($theme-step-indicator-segment-height)} + #{units($step-indicator-label-margin-top)}
    );
  }
}

.usa-step-indicator--no-labels {
  .usa-step-indicator__segment-label {
    // Don't show labels, even if they exist
    display: none;
  }
}

.usa-step-indicator--centered {
  @include u-margin-x($theme-step-indicator-gap / -2);

  .usa-step-indicator__segment {
    @include u-margin-x($theme-step-indicator-gap / 2);

    &:before {
      left: calc(
        50% - ((#{units($theme-step-indicator-counter-size)} + #{units($theme-step-indicator-counter-gap)}) / 2)
      );
    }

    &:first-child {
      &:after {
        left: 50%;
        right: 0;
        width: auto;
      }
    }
    &:last-child {
      &:after {
        display: block;
        left: 0;
        right: 50%;
        width: auto;
      }
    }
  }

  .usa-step-indicator__segment-label {
    // Balance label padding
    @include u-padding-x(1);
    // Center labels
    text-align: center;
  }

  &.usa-step-indicator--no-counter,
  &.usa-step-indicator--no-labels {
    .usa-step-indicator__segment {
      // Use full-width segments
      &:first-child {
        &:after {
          left: 0;
        }
      }
      &:last-child {
        &:after {
          right: 0;
        }
      }
    }
  }
}