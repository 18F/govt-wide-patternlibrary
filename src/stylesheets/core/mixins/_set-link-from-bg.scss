@mixin set-link-from-bg(
  $bg-color,
  $preferred-link-color: $theme-link-color,
  $fallback-link-color: $theme-link-reverse-color,
  $wcag-target: "AA"
) {
  $magic-numbers: (
    "AA": 50,
    "AAA": 70,
    "AA-large": 40
  );
  $grade-step: 10;
  $grade-fail-cases: (0, 100);

  @if $preferred-link-color == default {
    $preferred-link-color: $theme-link-color;
  }

  $target-magic-number: map-get($magic-numbers, $wcag-target);
  $bg-grade: get-color-grade($bg-color);
  $our-link-tokens: ($preferred-link-color, $fallback-link-color);

  $found-match: false;
  @each $link-token in $our-link-tokens {
    @if not $found-match {
      // decompose the link into separate vars
      $decomposed: decompose($link-token);
      $link-family: nth($decomposed, 1);
      $link-grade: if(nth($decomposed, 2) >= 10, nth($decomposed, 2), 0);
      $link-vivid: "";
      @if nth($decomposed, 3) {
        $link-vivid: "v";
      }
      $link-magic-number: abs($bg-grade - $link-grade);
      // check link token
      @if $link-magic-number >= $target-magic-number {
        $found-match: true;
        color: color($link-token);

        // if link is darker than bg, use darker hover
        @if ($link-grade > $bg-grade) and ($link-grade != 100) {
          $hover-grade: $link-grade + $grade-step;
          $hover-vivid: if($hover-grade == 90, "", $link-vivid);
          $hover-token: if(
            $hover-grade == 100,
            "black",
            #{$link-family}-#{$hover-grade}#{$hover-vivid}
          );
          &:hover,
          &:active {
            color: color($hover-token);
          }
        }

        // if link is lighter than bg, use lighter hover
        @else if $link-grade != 0 {
          $hover-grade: $link-grade - $grade-step;
          $hover-token: if(
            $hover-grade == 0,
            "white",
            #{$link-family}-#{$hover-grade}#{$link-vivid}
          );
          &:hover,
          &:active {
            color: color($hover-token);
          }
        }
      }
    }
  } // end @each

  @if not $found-match {
    @error "Neither '#{$preferred-link-color}' nor '#{$fallback-link-color}' have can be #{$wcag-target} contrast links on a '#{$bg-color}' background.";
  }
}
