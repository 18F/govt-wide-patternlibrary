@use "sass:map";
@use "sass:string";
@use "sass:list";

@use "../../functions" as *;
@use "../../variables" as *;
@use "../../tokens/font" as *;
@use "../../settings" as *;

$font-face-filetype-library: (
  "woff2": "woff2",
  "woff": "woff",
  "ttf": "truetype",
);
$font-face-default-filetypes: "woff2", "woff", "ttf";

@function fontFaceFormats($path, $filetypes) {
  $list: ();
  $format: null;

  @each $filetype in $filetypes {
    @if map.has-key($map: $font-face-filetype-library, $key: $filetype) {
      $format: map.get($map: $font-face-filetype-library, $key: $filetype);
    } 
    @else {
      @error "Font filetype \"#{$filetype}\" needs to be one of the following: #{$font-face-default-filetypes}";
    }
    $entry: url(#{$path}.#{$filetype}) format("#{$format}");
    $list: list.append($list, $entry, $separator: "comma");
  }

  @return $list;
}

// Output the @font-face rule
@mixin at-font-face($display-name, $file-path, $filetypes, $font-weight, $font-style) {
  // TODO: If $theme-use-rails-pipeline use font-url() statements
  // instead of url()
  // Dunno why I can't do this without an error...

  @font-face {
    font-family: $display-name;
    font-style: string.unquote($font-style);
    font-weight: $font-weight;
    font-display: fallback;
    src: fontFaceFormats($file-path, $filetypes);
  }
}

// Loop through weights, then call at-font-face
@mixin generate-font-face(
  $font-style-src,
  $output-weights,
  $display-name,
  $dir,
  $font-style,
  $filetypes
) {
  @each $font-weight, $filename in $font-style-src {
    @each $key, $output-weight in $output-weights {
      @if $output-weight == $font-weight and $filename {
        @include at-font-face(
          "#{$display-name}",
          // TODO: Why is this path causing problems?
          "#{$theme-font-path}/#{$dir}/#{$filename}",
          $filetypes,
          #{$font-weight},
          string.unquote("#{$font-style}")
        );
      }
    }
  }
}

// Collect all font metadata, then call generate-font-face
@mixin render-font-face($typeface-token, $src) {
  $generate: false;
  $this-src: ();
  $output-weights: $project-font-weights;
  @if $theme-generate-all-weights {
    $output-weights: (
      100: 100,
      200: 200,
      300: 300,
      400: 400,
      500: 500,
      600: 600,
      700: 700,
      800: 800,
      900: 900,
    );
  }

  $typeface-metadata: map.get($all-typeface-tokens, $typeface-token);

  // If the typeface has src in its USWDS metadata, generate and
  // set $this-src
  @if map.get($typeface-metadata, src) {
    $generate: true;
    $this-src: map.get($typeface-metadata, src);
  }

  // If the typeface has custom src sefined, generate and override
  // any existing USWDS src
  @if $src {
    $generate: true;
    $this-src: $src;
  }

  @if $generate {
    $display-name: map.get($typeface-metadata, display-name);
    $roman: map.get($this-src, roman);
    $italic: map.get($this-src, italic);
    $dir: map.get($this-src, dir);
    $filetypes: if(
      map.has-key($this-src, "filetypes"),
      map.get($this-src, "filetypes"),
      $font-face-default-filetypes
    );
    @debug "#{$display-name} filetypes: #{$filetypes}";

    @if $roman {
      @include generate-font-face(
        $roman,
        $output-weights,
        $display-name,
        $dir,
        normal,
        $filetypes
      );
    }

    @if $italic {
      @include generate-font-face(
        $italic,
        $output-weights,
        $display-name,
        $dir,
        italic,
        $filetypes
      );
    }
  }
}
